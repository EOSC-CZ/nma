{#def record, extra_context, md #}

{% set ns = namespace(localized_title=None, issued_found=False)%}
{% if md.alternate_titles %}
    {% for additionalTitle in array(md.alternate_titles) %}
        {% if additionalTitle.type == "TranslatedTitle" and additionalTitle.title.lang|string == current_i18n.language %}
            {% set ns.localized_title = additionalTitle.title.value|string %}
        {% endif %}
    {% endfor %}
{% endif %}

<div class="ui padded segment detail-main-record-segment">
  <div>
    {# <span class="text-medium">{{_('metadata/time_references/date_type.label')}}</span>: #}
    {% for date in array(md.time_references) if not ns.issued_found %}
      {% if date.date_type.id|string == "issued" %}
        <span title="{{_('metadata/time_references/date_type.label')}}" aria-description="{{_('metadata/time_references/date_type.help')}}">
          <IValue value={date.date} />
        </span>
        {% set ns.issued_found = True %}
      {% endif %}
    {% endfor %}
    {% if md.version._has_value %}{% if ns.issued_found %}|{% endif %}
    <span title="{{_('metadata/version.label')}}" aria-description="{{_('metadata/version.help')}}">
      {{_('metadata/version.label')}}: <IValue value={md.version} />
    </span>
    {% endif %}
  </div>
  
  <h1 class="ui header">
    {% if ns.localized_title %}
      {{ ns.localized_title }}
    {% else %}
      <IValue value={md.title} placeholder={md.alternateTitles.0.value if md.alternateTitles._has_value else _("Title not provided")} />
    {% endif %}
  </h1>

  <hr class="ui divider" />

  <dl>
    <IField d={md.alternate_titles}>
      <Multilingual data={md.alternate_titles|map(attribute='title')} />
    </IField>

    <Creatibutors qualified_relations={md.qualified_relations} search_link={record.links.search_link}></Creatibutors>

    <VocabularyItem vocabulary={md.resource_type} vocabulary_type="resource-types" search_link={record.links.search_link} searchFacet="metadata_resource_type" />

    <Subjects subjects={md.subjects} search_link={record.links.search_link} />

    {# <AccordionField label={_('metadata/descriptions.label')} title_class="detail-record-description">
      <Multilingual data={md.descriptions} />
    </AccordionField> #}

    <IField d={md.descriptions}>
      {% set descriptions = array(md.descriptions)|sort(reverse=true, attribute='lang') %}
      {% for description in descriptions %}
      <div role="list" class="ui list">
        <div role="listitem" class="item" aria-label="{{ description._ui_label }}">
          {# {% if description.lang|string|lower != "und" %} #}
          <span class="dark-grey" title="{{description.lang._ui_label}}" aria-description="{{description.lang._ui_help}}">[{{ description.lang|string|upper }}]</span> 
          {# {% endif %} #}
          {{ description._ui_value.value|safe }}
        </div>
      </div>
      {% endfor %}
    </IField>
    {# Change from Multilingual to display descriptions under each other with a batch #}

    <AccordionField label={_('Additional details')} title_class="detail-record-description" active>
      <ITable>
        <ITableField d={md.primary_language}>
          <VocabularyItem vocabulary={md.primary_language} vocabulary_type="languages" search_link={record.links.search_link} searchFacet="metadata_primary_language" />
        </ITableField>

        <ITableField d={md.funding_references}>
          <FundingReference funding_references={md.funding_references} search_link={record.links.search_link} />
        </ITableField>

        <TableTimeReferences time_references={md.time_references} excluded_date_types={["issued"]} search_link={record.links.search_link} />

        {# {% for date in array(md.time_references) %}
          {% if date.date_type.id|string != "issued" %}
            <ITableField d={date} label={date.date_type.title|capitalize}>
              <IValue value={date.date} />
            </ITableField>
          {% endif %}
        {% endfor %} #}

        <ITableField d={md.locations}>
          <Locations locations={md.locations} search_link={record.links.search_link} />
        </ITableField>

        <ITableField d={md.related_resources}>
          <RelatedResources related_resources={md.related_resources} search_link={record.links.search_link} />
        </ITableField>

        {# {% if md.primary_language %}
        <Field label={_('metadata/primary_language.label')}>
          <VocabularyItem vocabulary={md.primary_language} vocabulary_type="languages" search_link={record.links.search_link} searchFacet="metadata_primary_language" />
        </Field>
        {% endif %} #}

        {# {% if md.funding_references %}
        <Field label={ _('metadata/funding_references.label') }>
          <FundingReference funding_references={md.funding_references} search_link={record.links.search_link} />
        </Field>
        {% endif %} #}
      </ITable>
    </AccordionField>

    {% if md.distribution_downloadable_files %}
    <AccordionField label={_('Files')} title_class="detail-record-description" active>
      <FilesTable files={md.distribution_downloadable_files} search_link={record.links.search_link} />
    </AccordionField>
    {% endif %}
  </dl>
</div>